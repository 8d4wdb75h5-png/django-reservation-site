{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
<<<<<<< HEAD
  <link rel="stylesheet" href="{% static 'reservations/style.css' %}">
=======
  <meta charset="UTF-8" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- 自作CSS -->
  <link rel="stylesheet" href="{% static 'reservations/style.css' %}">

  <!-- flatpickr (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
>>>>>>> 4b0b3bc (restore index.html with bootstrap and flatpickr)
</head>

<body>

  <!-- 日付フィルター -->
  <form method="get" class="filter container mt-4">
    <label class="form-label">日付:</label>
    <input
      id="date-picker"
      type="text"
      name="date"
      placeholder="日付を選択"
      value="{{ qdate|date:'Y-m-d' }}"
      class="form-control"
    >
    <button type="submit" class="btn btn-primary">表示</button>
    <a href="/" class="btn btn-outline-secondary">リセット</a>
  </form>

  {{ available_dates|json_script:"available-dates" }}

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("available-dates");
      const availableDates = el ? JSON.parse(el.textContent) : [];

      flatpickr("#date-picker", {
        locale: "ja",
        dateFormat: "Y-m-d",
        disableMobile: true,
        minDate: "today",
        enable: [
          (date) => availableDates.includes(flatpickr.formatDate(date, "Y-m-d"))
        ],
        onDayCreate: function (dObj, dStr, fp, dayElem) {
          const dow = dayElem.dateObj.getDay();
          if (dow === 0) dayElem.classList.add("is-sun");
          if (dow === 6) dayElem.classList.add("is-sat");
        },
      });
    });
  </script>

  <div class="container">
    <p class="sub">
      管理画面で作った予約枠を一覧表示し、空きがあれば予約できます（満席は予約不可）。
      予約はPOST+DBロックで二重予約を防止しています。
    </p>

    <ul class="feature">
      <li>予約枠一覧（DB連携）</li>
      <li>満席制御（残り0は予約不可）</li>
      <li>予約処理（POST）</li>
      <li>二重予約（transaction + select_for_update）</li>
    </ul>

    <div class="container my-4">
      <ul class="list-unstyled">
        {% for slot in slots %}
          <li class="mb-3">
            <div class="card shadow-sm">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">
                     {{ slot.date|date:"Y年n月j日(D)" }} {{ slot.time|time:"H:i" }}
                  </div>
                  <span class="badge text-bg-secondary">
                    残り: {{ slot.capacity }} 枠
                  </span>
                </div>

                <div>
                   {% if slot.capacity > 0 %}
                    <form action="{% url 'reservations:reserve' slot.id %}" method="post" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-success">予約する</button>
                    </form>
                  {% else %}
                    <button class="btn btn-secondary" disabled>満席</button>
                  {% endif %}
                </div>
              </div>
            </div>
          </li>
        {% empty %}
          <li class="text-muted">まだ枠がありません</li>
        {% endfor %}
      </ul>
    </div>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

